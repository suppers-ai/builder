{{template "base.html" .}}

{{define "styles"}}
<link rel="stylesheet" href="https://unpkg.com/lucide@latest/font/lucide.min.css">
<style>
    .main-card {
        padding: 2rem;
    }
    .content-area {
        padding: 2rem;
    }
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }
    .page-title {
        font-size: 1.5rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .calculate-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
    }
    @media (max-width: 1024px) {
        .calculate-container {
            grid-template-columns: 1fr;
        }
    }
    .section-card {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 1.5rem;
    }
    .section-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .form-group {
        margin-bottom: 1.5rem;
    }
    .form-label {
        display: block;
        margin-bottom: 0.5rem;
        color: #666;
        font-size: 0.9rem;
        font-weight: 500;
    }
    .form-label span {
        color: #dc3545;
    }
    .form-input, .form-select {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 1rem;
        background: #f8f9fa;
    }
    .form-input:focus, .form-select:focus {
        outline: none;
        border-color: #667eea;
        background: white;
    }
    .variable-group {
        background: #f8f9fa;
        border-radius: 6px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    .variable-item {
        margin-bottom: 1rem;
    }
    .variable-item:last-child {
        margin-bottom: 0;
    }
    .variable-label {
        display: block;
        font-size: 0.9rem;
        color: #666;
        margin-bottom: 0.25rem;
    }
    .variable-name {
        font-family: monospace;
        font-size: 0.85rem;
        color: #999;
    }
    .variable-description {
        font-size: 0.85rem;
        color: #999;
        margin-top: 0.25rem;
    }
    .btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1rem;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s;
    }
    .btn-primary {
        background: #667eea;
        color: white;
    }
    .btn-primary:hover {
        background: #5a67d8;
    }
    .btn-secondary {
        background: #6c757d;
        color: white;
    }
    .btn-secondary:hover {
        background: #5a6268;
    }
    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .results-section {
        margin-top: 2rem;
    }
    .result-card {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1rem;
    }
    .result-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .result-item {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding: 0.75rem;
        background: #f8f9fa;
        border-radius: 4px;
        margin-bottom: 0.5rem;
    }
    .result-item > div:first-child {
        flex: 1;
    }
    .result-item:last-child {
        margin-bottom: 0;
    }
    .result-label {
        font-size: 0.9rem;
        color: #666;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .result-value {
        font-size: 1.1rem;
        font-weight: 600;
        color: #333;
        font-family: monospace;
    }
    .condition-badge {
        background: #fef3c7;
        color: #d97706;
        padding: 0.2rem 0.5rem;
        border-radius: 3px;
        font-size: 0.8rem;
        font-weight: 500;
    }
    .condition-met {
        background: #d1fae5;
        color: #065f46;
    }
    .condition-not-met {
        background: #fee2e2;
        color: #991b1b;
    }
    .calculation-badge {
        background: #dbeafe;
        color: #1d4ed8;
        padding: 0.2rem 0.5rem;
        border-radius: 3px;
        font-size: 0.8rem;
        font-weight: 500;
        font-family: monospace;
    }
    .total-row {
        background: #667eea;
        color: white;
        padding: 1rem;
        border-radius: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 1rem;
    }
    .total-label {
        font-size: 1.1rem;
        font-weight: 600;
    }
    .total-value {
        font-size: 1.5rem;
        font-weight: 600;
        font-family: monospace;
    }
    
    /* Enhanced formula display styles */
    .result-item.active {
        background: #f9fafb;
        border-left: 3px solid #667eea;
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 4px;
    }
    .result-item.inactive {
        opacity: 0.6;
        padding: 0.75rem 1rem;
        margin-bottom: 0.5rem;
    }
    .result-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
    }
    .step-number {
        background: #e5e7eb;
        color: #374151;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.85rem;
        font-weight: 600;
    }
    .formula-display {
        margin-top: 0.75rem;
        padding-left: 2rem;
    }
    .formula-label {
        color: #6b7280;
        font-size: 0.9rem;
        margin-bottom: 0.25rem;
        font-weight: 500;
    }
    .formula-calculation {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-family: 'Courier New', monospace;
        background: white;
        padding: 0.75rem;
        border-radius: 4px;
        border: 1px solid #e5e7eb;
    }
    .formula-expression {
        color: #374151;
        font-size: 1rem;
    }
    .formula-equals {
        color: #9ca3af;
        font-weight: 600;
    }
    .formula-result {
        color: #059669;
        font-weight: 600;
        font-size: 1.1rem;
    }
    .formula-steps {
        margin-top: 0.5rem;
        color: #6b7280;
        font-style: italic;
    }
    
    /* Tooltip styles */
    .variable-token {
        display: inline-block;
        background: #e5e7eb;
        padding: 0.125rem 0.375rem;
        border-radius: 3px;
        margin: 0 0.125rem;
        cursor: help;
        position: relative;
        transition: background 0.2s;
    }
    .variable-token:hover {
        background: #d1d5db;
    }
    .calculation-token {
        display: inline-block;
        background: #ddd6fe;
        padding: 0.125rem 0.375rem;
        border-radius: 3px;
        margin: 0 0.125rem;
        cursor: help;
        position: relative;
        transition: background 0.2s;
        border: 1px solid #c4b5fd;
    }
    .calculation-token:hover {
        background: #c4b5fd;
    }
    .variable-tooltip {
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: #1f2937;
        color: white;
        padding: 0.75rem;
        border-radius: 6px;
        font-size: 0.875rem;
        white-space: nowrap;
        display: none;
        z-index: 1000;
        min-width: 200px;
        margin-bottom: 0.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .variable-tooltip::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        border: 6px solid transparent;
        border-top-color: #1f2937;
    }
    .variable-token:hover .variable-tooltip,
    .calculation-token:hover .variable-tooltip {
        display: block;
    }
    .tooltip-header {
        font-weight: 600;
        margin-bottom: 0.25rem;
        color: #fbbf24;
    }
    .tooltip-row {
        display: flex;
        justify-content: space-between;
        gap: 1rem;
        margin: 0.25rem 0;
        white-space: nowrap;
    }
    .tooltip-label {
        color: #9ca3af;
    }
    .tooltip-value {
        color: #fff;
        font-weight: 500;
    }
    .tooltip-constraints {
        margin-top: 0.5rem;
        padding-top: 0.5rem;
        border-top: 1px solid #374151;
        font-size: 0.8rem;
        color: #9ca3af;
    }
    .operator-token {
        display: inline-block;
        padding: 0 0.25rem;
        color: #6b7280;
        font-weight: 600;
    }
    
    .error-message {
        background: #fee2e2;
        color: #991b1b;
        padding: 1rem;
        border-radius: 4px;
        margin-top: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .success-message {
        background: #d1fae5;
        color: #065f46;
        padding: 1rem;
        border-radius: 4px;
        margin-top: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .loading {
        display: none;
        text-align: center;
        padding: 2rem;
        color: #666;
    }
    .loading.show {
        display: block;
    }
    .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #667eea;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .preset-buttons {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
    }
    .btn-preset {
        padding: 0.5rem 1rem;
        background: #e5e7eb;
        color: #374151;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.2s;
    }
    .btn-preset:hover {
        background: #d1d5db;
    }
</style>
{{end}}

{{define "content"}}
<div class="main-wrapper">
    <div class="header">
        <div class="logo">
            <span>FormulaPricing</span>
        </div>
        <div>
            <span style="margin-right: 1rem; color: #666;">{{.UserEmail}}</span>
            <a href="/logout" class="logout-btn">Logout</a>
        </div>
    </div>

    <div class="tabs">
        <a href="/dashboard" class="tab">Dashboard</a>
        <a href="/variables" class="tab">Variables</a>
        <a href="/calculations" class="tab">Calculations</a>
        <a href="/conditions" class="tab">Conditions</a>
        <a href="/pricing" class="tab">Pricing</a>
        <a href="/calculate" class="tab active">Calculate</a>
    {{if eq .UserRole "admin"}}<a href="/users" class="tab">Users</a>{{end}}
        <a href="/users" class="tab">Users</a>
        <a href="/dashboard/logs" class="tab">Logs</a>
        <a href="/dashboard/settings" class="tab">Settings</a>
    </div>

    <div class="container">
        <div class="main-card">
            <div class="content-area">
                <div class="page-header">
                    <h1 class="page-title">
                        <i data-lucide="calculator" style="width: 28px; height: 28px; color: #10b981;"></i>
                        Calculate Pricing
                    </h1>
                </div>

                <div class="calculate-container">
                    <!-- Input Section -->
                    <div>
                        <div class="section-card">
                            <h2 class="section-title">
                                <i data-lucide="settings" style="width: 20px; height: 20px;"></i>
                                Configuration
                            </h2>
                            
                            <form id="calculateForm">
                                <div class="form-group">
                                    <label class="form-label">
                                        Pricing Strategy <span>*</span>
                                    </label>
                                    <select id="pricingSelect" class="form-select" required>
                                        <option value="">Select pricing strategy...</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">
                                        Variables <span>*</span>
                                    </label>
                                    
                                    <div class="preset-buttons">
                                        <button type="button" class="btn-preset" onclick="loadPreset('family')">
                                            👨‍👩‍👧‍👦 Family Pricing
                                        </button>
                                        <button type="button" class="btn-preset" onclick="loadPreset('weekend')">
                                            🏠 Accommodation
                                        </button>
                                        <button type="button" class="btn-preset" onclick="loadPreset('minimal')">
                                            🛒 E-commerce
                                        </button>
                                        <button type="button" class="btn-preset" onclick="clearVariables()">
                                            ✖ Clear All
                                        </button>
                                    </div>
                                    
                                    <div class="variable-group" id="variablesContainer">
                                        <!-- Variables will be loaded here -->
                                    </div>
                                </div>

                                <div style="display: flex; gap: 1rem;">
                                    <button type="submit" class="btn btn-primary">
                                        <i data-lucide="play" style="width: 18px; height: 18px;"></i>
                                        Calculate
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="clearResults()">
                                        <i data-lucide="refresh-cw" style="width: 18px; height: 18px;"></i>
                                        Clear
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Results Section -->
                    <div>
                        <div class="section-card">
                            <h2 class="section-title">
                                <i data-lucide="bar-chart-2" style="width: 20px; height: 20px;"></i>
                                Results
                            </h2>
                            
                            <div id="resultsContainer">
                                <div style="text-align: center; padding: 3rem; color: #999;">
                                    <i data-lucide="info" style="width: 48px; height: 48px; margin: 0 auto 1rem;"></i>
                                    <p>Enter values and click Calculate to see results</p>
                                </div>
                            </div>
                            
                            <div class="loading" id="loadingIndicator">
                                <div class="spinner"></div>
                                <p>Calculating...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
<script>
    lucide.createIcons();
    
    let availablePricings = [];
    let availableVariables = [];
    let currentPricingVariables = [];
    
    // Load data on page load
    async function loadData() {
        try {
            // Load pricing strategies
            const pricingRes = await fetch('/api/pricing');
            if (pricingRes.ok) {
                availablePricings = await pricingRes.json();
                const select = document.getElementById('pricingSelect');
                availablePricings.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.name;
                    option.textContent = `${p.name} - ${p.description || 'No description'}`;
                    select.appendChild(option);
                });
                
                // Add change listener to pricing select
                select.addEventListener('change', async (e) => {
                    if (e.target.value) {
                        await loadPricingVariables(e.target.value);
                    } else {
                        // Clear variables if no pricing selected
                        currentPricingVariables = [];
                        renderVariables();
                    }
                });
            }
            
            // Load all variables (fallback)
            const variablesRes = await fetch('/api/variables');
            if (variablesRes.ok) {
                availableVariables = await variablesRes.json();
            }
        } catch (error) {
            console.error('Error loading data:', error);
        }
    }
    
    async function loadPricingVariables(pricingName) {
        try {
            const response = await fetch(`/api/pricing/${encodeURIComponent(pricingName)}/variables`);
            if (response.ok) {
                const data = await response.json();
                currentPricingVariables = data.required_variables || [];
                renderVariables();
            } else {
                // Fallback to showing all variables
                currentPricingVariables = availableVariables;
                renderVariables();
            }
        } catch (error) {
            console.error('Error loading pricing variables:', error);
            // Fallback to showing all variables
            currentPricingVariables = availableVariables;
            renderVariables();
        }
    }
    
    function renderVariables() {
        const container = document.getElementById('variablesContainer');
        container.innerHTML = '';
        
        const variablesToRender = currentPricingVariables.length > 0 ? currentPricingVariables : availableVariables;
        
        if (variablesToRender.length === 0) {
            container.innerHTML = '<p style="color: #999; text-align: center; padding: 1rem;">Select a pricing strategy to see required variables</p>';
            return;
        }
        
        // Group variables by unique/system vs user variables
        const systemVars = variablesToRender.filter(v => v.is_unique);
        const userVars = variablesToRender.filter(v => !v.is_unique);
        
        // Show system variables first if any
        if (systemVars.length > 0) {
            const systemDiv = document.createElement('div');
            systemDiv.innerHTML = '<h4 style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">System Variables</h4>';
            systemVars.forEach(v => {
                systemDiv.appendChild(createVariableInput(v));
            });
            container.appendChild(systemDiv);
            
            if (userVars.length > 0) {
                container.appendChild(document.createElement('hr'));
            }
        }
        
        // Show user variables
        if (userVars.length > 0) {
            const userDiv = document.createElement('div');
            if (systemVars.length > 0) {
                userDiv.innerHTML = '<h4 style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem; margin-top: 0.5rem;">Input Variables</h4>';
            }
            userVars.forEach(v => {
                userDiv.appendChild(createVariableInput(v));
            });
            container.appendChild(userDiv);
        }
    }
    
    function createVariableInput(v) {
        const div = document.createElement('div');
        div.className = 'variable-item';
        
        const inputType = v.value_type === 'boolean' ? 'checkbox' : 
                         v.value_type === 'number' ? 'number' : 'text';
        
        // For system variables that are read-only
        const isReadOnly = v.is_unique && v.unique_behavior;
        
        // Parse constraints if they exist
        let minValue = '';
        let maxValue = '';
        let pattern = '';
        if (v.constraints) {
            if (v.constraints.min !== undefined) minValue = `min="${v.constraints.min}"`;
            if (v.constraints.max !== undefined) maxValue = `max="${v.constraints.max}"`;
            if (v.constraints.pattern) pattern = `pattern="${v.constraints.pattern}"`;
        }
        
        if (v.value_type === 'boolean') {
            div.innerHTML = `
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                    <input type="checkbox" 
                           id="var-${v.variable_name}" 
                           data-name="${v.variable_name}"
                           data-type="${v.value_type}"
                           ${isReadOnly ? 'disabled' : ''} 
                           ${v.default_value === 'true' || v.default_value === true ? 'checked' : ''} />
                    <span>
                        <strong>${v.display_name}</strong>
                        <span class="variable-name">(${v.variable_name})</span>
                        ${isReadOnly ? '<span style="color: #999; font-size: 0.8rem;">[Auto-managed]</span>' : ''}
                    </span>
                </label>
                ${v.description ? `<div class="variable-description">${v.description}</div>` : ''}
                ${v.unique_behavior ? `<div style="color: #666; font-size: 0.85rem; font-style: italic; margin-top: 0.25rem;">ℹ️ ${v.unique_behavior}</div>` : ''}
            `;
        } else {
            div.innerHTML = `
                <label class="variable-label">
                    ${v.display_name}
                    <span class="variable-name">(${v.variable_name})</span>
                    ${isReadOnly ? '<span style="color: #999; font-size: 0.8rem;">[Auto-managed]</span>' : ''}
                </label>
                <input type="${inputType}" 
                       id="var-${v.variable_name}" 
                       data-name="${v.variable_name}"
                       data-type="${v.value_type}"
                       class="form-input" 
                       placeholder="${v.default_value || (v.value_type === 'number' ? '0' : 'Enter value')}"
                       ${v.value_type === 'number' ? 'step="0.01"' : ''}
                       ${minValue} ${maxValue} ${pattern}
                       ${isReadOnly ? 'readonly style="background: #f0f0f0; cursor: not-allowed;"' : ''} 
                       ${v.default_value ? `value="${v.default_value}"` : ''}
                       oninput="validateInput(this)" />
                ${v.description ? `<div class="variable-description">${v.description}</div>` : ''}
                ${v.unique_behavior ? `<div style="color: #666; font-size: 0.85rem; font-style: italic; margin-top: 0.25rem;">ℹ️ ${v.unique_behavior}</div>` : ''}
                ${v.constraints ? `<div class="constraint-info">${formatConstraints(v.constraints)}</div>` : ''}
                <div class="validation-error" style="color: #dc2626; font-size: 0.85rem; margin-top: 0.25rem; display: none;"></div>
            `;
        }
        
        return div;
    }
    
    function formatConstraints(constraints) {
        let parts = [];
        if (constraints.min !== undefined) parts.push(`Min: ${constraints.min}`);
        if (constraints.max !== undefined) parts.push(`Max: ${constraints.max}`);
        if (constraints.enum) parts.push(`Options: ${constraints.enum.join(', ')}`);
        return parts.length > 0 ? `<small style="color: #6b7280;">Constraints: ${parts.join(', ')}</small>` : '';
    }
    
    function validateInput(input) {
        const errorDiv = input.parentElement.querySelector('.validation-error');
        if (!errorDiv) return true;
        
        const value = input.value;
        const type = input.dataset.type;
        let error = '';
        
        if (type === 'number') {
            const num = parseFloat(value);
            if (isNaN(num) && value !== '') {
                error = 'Please enter a valid number';
            } else if (input.min && num < parseFloat(input.min)) {
                error = `Value must be at least ${input.min}`;
            } else if (input.max && num > parseFloat(input.max)) {
                error = `Value must be at most ${input.max}`;
            }
        }
        
        if (error) {
            errorDiv.textContent = error;
            errorDiv.style.display = 'block';
            input.style.borderColor = '#dc2626';
            return false;
        } else {
            errorDiv.style.display = 'none';
            input.style.borderColor = '';
            return true;
        }
    }
    
    // Keep the old renderVariables for fallback
    function renderAllVariables() {
        const container = document.getElementById('variablesContainer');
        container.innerHTML = '';
        
        availableVariables.forEach(v => {
            const div = document.createElement('div');
            div.className = 'variable-item';
            
            const inputType = v.value_type === 'boolean' ? 'checkbox' : 
                             v.value_type === 'number' ? 'number' : 'text';
            
            if (v.value_type === 'boolean') {
                div.innerHTML = `
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="var-${v.variable_name}" data-name="${v.variable_name}" />
                        <span>
                            <strong>${v.display_name}</strong>
                            <span class="variable-name">(${v.variable_name})</span>
                        </span>
                    </label>
                    ${v.description ? `<div class="variable-description">${v.description}</div>` : ''}
                `;
            } else {
                div.innerHTML = `
                    <label class="variable-label">
                        ${v.display_name}
                        <span class="variable-name">(${v.variable_name})</span>
                    </label>
                    <input type="${inputType}" 
                           id="var-${v.variable_name}" 
                           data-name="${v.variable_name}"
                           class="form-input" 
                           placeholder="${v.value_type === 'number' ? '0' : 'Enter value'}"
                           ${v.value_type === 'number' ? 'step="0.01"' : ''} />
                    ${v.description ? `<div class="variable-description">${v.description}</div>` : ''}
                `;
            }
            
            container.appendChild(div);
        });
    }
    
    async function loadPreset(type) {
        clearVariables();
        
        const presets = {
            family: {
                pricing: 'standard_family_pricing',
                values: {
                    'numberOfAdults': 2,
                    'numberOfChildren': 3,
                    'numberOfInfants': 1,
                    'numberOfSeniors': 0,
                    'adultPrice': 50,
                    'childPrice': 25,
                    'infantPrice': 10,
                    'seniorPrice': 40
                }
            },
            weekend: {
                pricing: 'accommodation_pricing',
                values: {
                    'numberOfNights': 2,
                    'numberOfGuests': 4,
                    'pricePerNight': 150,
                    'cleaningFee': 50,
                    'petFee': 25,
                    'hasPets': true,
                    'serviceFee': 0.12,
                    'extraGuestFee': 20,
                    'baseOccupancy': 2
                }
            },
            minimal: {
                pricing: 'simple_ecommerce_pricing',
                values: {
                    'basePrice': 49.99,
                    'quantity': 3,
                    'shippingFee': 10,
                    'taxRate': 0.08
                }
            }
        };
        
        const preset = presets[type];
        if (preset) {
            // Select the pricing strategy
            const pricingSelect = document.getElementById('pricingSelect');
            if (preset.pricing && availablePricings.find(p => p.name === preset.pricing)) {
                pricingSelect.value = preset.pricing;
                // Load the pricing variables
                await loadPricingVariables(preset.pricing);
                
                // Wait a bit for the DOM to update
                setTimeout(() => {
                    // Set the preset values
                    Object.keys(preset.values).forEach(key => {
                        const input = document.getElementById(`var-${key}`);
                        if (input) {
                            if (input.type === 'checkbox') {
                                input.checked = preset.values[key];
                            } else {
                                input.value = preset.values[key];
                            }
                        }
                    });
                }, 100);
            }
        }
    }
    
    function clearVariables() {
        document.querySelectorAll('#variablesContainer input').forEach(input => {
            if (input.type === 'checkbox') {
                input.checked = false;
            } else {
                input.value = '';
            }
        });
    }
    
    function clearResults() {
        document.getElementById('resultsContainer').innerHTML = `
            <div style="text-align: center; padding: 3rem; color: #999;">
                <i data-lucide="info" style="width: 48px; height: 48px; margin: 0 auto 1rem;"></i>
                <p>Enter values and click Calculate to see results</p>
            </div>
        `;
        lucide.createIcons();
    }
    
    document.getElementById('calculateForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const pricingName = document.getElementById('pricingSelect').value;
        if (!pricingName) {
            alert('Please select a pricing strategy');
            return;
        }
        
        // Collect variables
        const variables = {};
        document.querySelectorAll('#variablesContainer input').forEach(input => {
            const name = input.getAttribute('data-name');
            if (input.type === 'checkbox') {
                variables[name] = input.checked;
            } else if (input.type === 'number') {
                variables[name] = parseFloat(input.value) || 0;
            } else {
                variables[name] = input.value || '';
            }
        });
        
        // Show loading
        document.getElementById('loadingIndicator').classList.add('show');
        document.getElementById('resultsContainer').style.display = 'none';
        
        try {
            const response = await fetch('/api/calculate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    pricing_name: pricingName,
                    variables: variables
                })
            });
            
            if (response.ok) {
                const data = await response.json();
                displayResults(data);
            } else {
                const error = await response.json();
                displayError(error.error || 'Calculation failed');
            }
        } catch (error) {
            displayError('Error: ' + error.message);
        } finally {
            document.getElementById('loadingIndicator').classList.remove('show');
            document.getElementById('resultsContainer').style.display = 'block';
        }
    });
    
    function createEnhancedFormula(formula, variables) {
        if (!formula) return formula;
        
        // Create a map of variable names to their info
        const varMap = {};
        if (variables && Array.isArray(variables)) {
            variables.forEach(v => {
                varMap[v.name] = v;
            });
        }
        
        // Parse the formula and create enhanced HTML
        const parts = formula.split(' ');
        const enhancedParts = parts.map(part => {
            // Check if it's an operator
            if (['+', '-', '*', '/'].includes(part)) {
                return `<span class="operator-token">${part}</span>`;
            }
            
            // Check if it's a number
            if (!isNaN(parseFloat(part))) {
                // Check if this might be a variable value
                const varName = Object.keys(varMap).find(name => 
                    varMap[name].value && varMap[name].value.toString() === part
                );
                
                if (varName && varMap[varName]) {
                    const varInfo = varMap[varName];
                    return createVariableToken(part, varInfo);
                }
                return `<span style="color: #059669; font-weight: 500;">${part}</span>`;
            }
            
            // It's a variable name
            if (varMap[part]) {
                return createVariableToken(part, varMap[part]);
            }
            
            return part;
        });
        
        return enhancedParts.join(' ');
    }
    
    function createVariableToken(display, varInfo) {
        const isCalculation = varInfo.is_calculation || varInfo.value_type === 'calculation';
        
        let tooltipContent = `
            <div class="tooltip-header">${varInfo.display_name || varInfo.name}</div>
        `;
        
        if (isCalculation) {
            tooltipContent += `<div style="margin-bottom: 0.5rem; color: #fbbf24; font-size: 0.85rem;">📊 Calculated Value</div>`;
        }
        
        if (varInfo.description) {
            tooltipContent += `<div style="margin-bottom: 0.5rem; color: #e5e7eb;">${varInfo.description}</div>`;
        }
        
        tooltipContent += `
            <div class="tooltip-row">
                <span class="tooltip-label">${isCalculation ? 'Calculation:' : 'Variable:'}</span>
                <span class="tooltip-value">${varInfo.name}</span>
            </div>
            <div class="tooltip-row">
                <span class="tooltip-label">Value:</span>
                <span class="tooltip-value">${typeof varInfo.value === 'number' ? varInfo.value.toFixed(2) : varInfo.value}</span>
            </div>
        `;
        
        if (!isCalculation) {
            tooltipContent += `
                <div class="tooltip-row">
                    <span class="tooltip-label">Type:</span>
                    <span class="tooltip-value">${varInfo.value_type || 'unknown'}</span>
                </div>
            `;
            
            if (varInfo.constraints && Object.keys(varInfo.constraints).length > 0) {
                tooltipContent += '<div class="tooltip-constraints">';
                if (varInfo.constraints.min !== undefined) {
                    tooltipContent += `Min: ${varInfo.constraints.min}<br>`;
                }
                if (varInfo.constraints.max !== undefined) {
                    tooltipContent += `Max: ${varInfo.constraints.max}<br>`;
                }
                if (varInfo.constraints.enum) {
                    tooltipContent += `Options: ${varInfo.constraints.enum.join(', ')}`;
                }
                tooltipContent += '</div>';
            }
        } else {
            tooltipContent += `
                <div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #374151; font-size: 0.8rem; color: #9ca3af;">
                    This value is calculated from other variables
                </div>
            `;
        }
        
        const tokenClass = isCalculation ? 'calculation-token' : 'variable-token';
        
        return `<span class="${tokenClass}">
            ${display}
            <div class="variable-tooltip">${tooltipContent}</div>
        </span>`;
    }
    
    function displayResults(data) {
        const container = document.getElementById('resultsContainer');
        let html = '';
        
        if (data.results && data.results.length > 0) {
            html += '<div class="result-card">';
            html += '<h3 class="result-title"><i data-lucide="list" style="width: 18px; height: 18px;"></i> Calculation Steps</h3>';
            
            data.results.forEach((result, index) => {
                const conditionClass = result.condition_met ? 'condition-met' : 'condition-not-met';
                const conditionText = result.condition_name || 'always';
                const conditionIcon = result.condition_met ? 'check' : 'x';
                
                // Enhanced formula display with tooltips
                let formulaDisplay = '';
                if (result.condition_met && result.resolved_formula) {
                    const enhancedFormula = createEnhancedFormula(result.resolved_formula, result.used_variables);
                    formulaDisplay = `
                        <div class="formula-display">
                            <div class="formula-label">${result.display_name || result.calculation_name}:</div>
                            <div class="formula-calculation">
                                <span class="formula-expression">${enhancedFormula}</span>
                                <span class="formula-equals">=</span>
                                <span class="formula-result">$${result.value.toFixed(2)}</span>
                            </div>
                            ${result.calculation_steps ? `
                                <div class="formula-steps">
                                    <small>Variables: ${result.calculation_steps}</small>
                                </div>
                            ` : ''}
                        </div>`;
                }
                
                html += `
                    <div class="result-item ${result.condition_met ? 'active' : 'inactive'}">
                        <div class="result-content">
                            <div class="result-header">
                                <span class="step-number">${index + 1}</span>
                                <span class="condition-badge ${conditionClass}">
                                    <i data-lucide="${conditionIcon}" style="width: 12px; height: 12px; display: inline-block;"></i>
                                    ${conditionText}
                                </span>
                                ${result.condition_met ? `
                                    <i data-lucide="arrow-right" style="width: 14px; height: 14px; color: #999;"></i>
                                    <span class="calculation-badge">${result.display_name || result.calculation_name}</span>
                                ` : ''}
                            </div>
                            ${formulaDisplay}
                        </div>
                        ${result.error ? `
                            <div class="error-message" style="margin-top: 0.5rem;">
                                <i data-lucide="alert-circle" style="width: 14px; height: 14px;"></i>
                                ${result.error}
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            html += '</div>';
        }
        
        // Summary
        if (data.summary && Object.keys(data.summary).length > 0) {
            html += '<div class="result-card">';
            html += '<h3 class="result-title"><i data-lucide="pie-chart" style="width: 18px; height: 18px;"></i> Summary</h3>';
            
            Object.keys(data.summary).forEach(key => {
                const item = data.summary[key];
                html += `
                    <div class="result-item">
                        <div class="result-label">${item.display_name || key}</div>
                        <div class="result-value">$${item.value.toFixed(2)}</div>
                    </div>
                `;
            });
            
            html += '</div>';
        }
        
        // Total
        html += `
            <div class="total-row">
                <div class="total-label">Total Amount</div>
                <div class="total-value">$${data.total.toFixed(2)}</div>
            </div>
        `;
        
        container.innerHTML = html;
        lucide.createIcons();
    }
    
    function displayError(message) {
        const container = document.getElementById('resultsContainer');
        container.innerHTML = `
            <div class="error-message">
                <i data-lucide="alert-circle" style="width: 20px; height: 20px;"></i>
                ${message}
            </div>
        `;
        lucide.createIcons();
    }
    
    // Load data when page loads
    loadData();
</script>
</div>
{{end}}