{{template "base.html" .}}

{{define "styles"}}
<link rel="stylesheet" href="https://unpkg.com/lucide@latest/font/lucide.min.css">
<style>
    .main-card {
        padding: 2rem;
    }
    .content-area {
        padding: 2rem;
    }
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }
    .page-title {
        font-size: 1.5rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1rem;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s;
    }
    .btn-primary {
        background: #333;
        color: white;
    }
    .btn-primary:hover {
        background: #555;
    }
    .btn-secondary {
        background: #6c757d;
        color: white;
    }
    .btn-secondary:hover {
        background: #5a6268;
    }
    .btn-danger {
        background: #dc3545;
        color: white;
    }
    .btn-danger:hover {
        background: #c82333;
    }
    .btn-sm {
        padding: 0.5rem 0.75rem;
        font-size: 0.875rem;
    }
    .pricing-card {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        transition: all 0.2s;
    }
    .pricing-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        border-color: #d0d0d0;
    }
    .pricing-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
    }
    .pricing-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #333;
        font-family: monospace;
    }
    .pricing-description {
        color: #666;
        margin-bottom: 1rem;
        font-size: 0.95rem;
    }
    .pricing-rules {
        background: #f8f9fa;
        border-radius: 6px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    .rules-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: #666;
        margin-bottom: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .rule-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 0.5rem;
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        margin-bottom: 0.5rem;
    }
    .rule-item:last-child {
        margin-bottom: 0;
    }
    .rule-number {
        background: #667eea;
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.85rem;
        font-weight: 600;
        flex-shrink: 0;
    }
    .rule-content {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        flex-wrap: wrap;
    }
    .rule-label {
        font-size: 0.85rem;
        color: #666;
        font-weight: 500;
    }
    .condition-badge {
        background: #fef3c7;
        color: #d97706;
        padding: 0.25rem 0.75rem;
        border-radius: 4px;
        font-size: 0.85rem;
        font-weight: 500;
        font-family: monospace;
    }
    .calculation-badge {
        background: #dbeafe;
        color: #1d4ed8;
        padding: 0.25rem 0.75rem;
        border-radius: 4px;
        font-size: 0.85rem;
        font-weight: 500;
        font-family: monospace;
    }
    .arrow-icon {
        color: #999;
    }
    .actions {
        display: flex;
        gap: 0.5rem;
    }
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: #666;
    }
    .empty-state h3 {
        margin-bottom: 1rem;
        color: #333;
    }
    /* Modal styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        animation: fadeIn 0.2s;
    }
    .modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .modal-content {
        background-color: white;
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        width: 90%;
        max-width: 700px;
        max-height: 90vh;
        overflow-y: auto;
        animation: slideIn 0.3s;
    }
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    @keyframes slideIn {
        from { transform: translateY(-50px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }
    .modal-title {
        font-size: 1.25rem;
        font-weight: 600;
    }
    .close-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #999;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .close-btn:hover {
        color: #666;
    }
    .form-group {
        margin-bottom: 1.5rem;
    }
    .form-label {
        display: block;
        margin-bottom: 0.5rem;
        color: #666;
        font-size: 0.9rem;
    }
    .form-label span {
        color: #dc3545;
    }
    .form-input, .form-select {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 1rem;
        background: #f8f9fa;
    }
    .form-input:focus, .form-select:focus {
        outline: none;
        border-color: #667eea;
        background: white;
    }
    .form-textarea {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 1rem;
        background: #f8f9fa;
        resize: vertical;
        min-height: 80px;
    }
    .form-textarea:focus {
        outline: none;
        border-color: #667eea;
        background: white;
    }
    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
        margin-top: 2rem;
    }
    .btn-cancel {
        background: #6c757d;
        color: white;
    }
    .btn-cancel:hover {
        background: #5a6268;
    }
    .help-text {
        font-size: 0.85rem;
        color: #666;
        margin-top: 0.25rem;
    }
    .rules-editor {
        background: #f8f9fa;
        border-radius: 6px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    .rule-editor-item {
        display: flex;
        gap: 1rem;
        align-items: flex-start;
        margin-bottom: 1rem;
        padding: 1rem;
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
    }
    .rule-editor-fields {
        flex: 1;
        display: flex;
        gap: 1rem;
    }
    .rule-field {
        flex: 1;
    }
    .rule-field label {
        display: block;
        font-size: 0.85rem;
        color: #666;
        margin-bottom: 0.25rem;
    }
    .btn-remove-rule {
        background: #dc3545;
        color: white;
        border: none;
        padding: 0.5rem;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .btn-remove-rule:hover {
        background: #c82333;
    }
    .btn-add-rule {
        background: #28a745;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
    }
    .btn-add-rule:hover {
        background: #218838;
    }
</style>
{{end}}

{{define "content"}}
<div class="main-wrapper">
    <div class="header">
        <div class="logo">
            <span>FormulaPricing</span>
        </div>
        <div>
            <span style="margin-right: 1rem; color: #666;">{{.UserEmail}}</span>
            <a href="/logout" class="logout-btn">Logout</a>
        </div>
    </div>

    <div class="tabs">
        <a href="/dashboard" class="tab">Dashboard</a>
        <a href="/variables" class="tab">Variables</a>
        <a href="/calculations" class="tab">Calculations</a>
        <a href="/conditions" class="tab">Conditions</a>
        <a href="/pricing" class="tab active">Pricing</a>
        <a href="/calculate" class="tab">Calculate</a>
        <a href="/purchases" class="tab">Purchases</a>
        {{if eq .UserRole "admin"}}
        <a href="/users" class="tab">Users</a>
        {{end}}
    </div>

<div class="container">
    <div class="main-card">
        <div class="content-area">
            <div class="page-header">
                <h1 class="page-title">
                    <i data-lucide="dollar-sign" style="width: 28px; height: 28px; color: #ef4444;"></i>
                    Pricing Management
                </h1>
                <button class="btn btn-primary" onclick="createPricing()">
                    <i data-lucide="plus" style="width: 20px; height: 20px;"></i>
                    New Pricing Strategy
                </button>
            </div>

            {{if .Pricings}}
                {{range .Pricings}}
                <div class="pricing-card">
                    <div class="pricing-header">
                        <div>
                            <h3 class="pricing-title">{{.Name}}</h3>
                            {{if .Description}}
                            <p class="pricing-description">{{.Description}}</p>
                            {{end}}
                        </div>
                        <div class="actions">
                            <button class="btn btn-secondary btn-sm" onclick="editPricing('{{.ID}}')">
                                <i data-lucide="edit" style="width: 16px; height: 16px;"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deletePricing('{{.ID}}', '{{.Name}}')">
                                <i data-lucide="trash-2" style="width: 16px; height: 16px;"></i>
                            </button>
                        </div>
                    </div>
                    
                    {{if .Pricing}}
                    <div class="pricing-rules">
                        <div class="rules-title">Pricing Rules ({{len .Pricing}})</div>
                        {{range $index, $rule := .Pricing}}
                        <div class="rule-item">
                            <div class="rule-number" data-index="{{$index}}"></div>
                            <div class="rule-content">
                                <span class="rule-label">IF</span>
                                <span class="condition-badge">{{if $rule.Condition}}{{$rule.Condition}}{{else}}always{{end}}</span>
                                <i data-lucide="arrow-right" class="arrow-icon" style="width: 16px; height: 16px;"></i>
                                <span class="rule-label">THEN</span>
                                <span class="calculation-badge">{{$rule.Calculation}}</span>
                            </div>
                        </div>
                        {{end}}
                    </div>
                    {{else}}
                    <div style="padding: 1rem; background: #f8f9fa; border-radius: 4px; color: #666; text-align: center;">
                        No pricing rules defined
                    </div>
                    {{end}}
                </div>
                {{end}}
            {{else}}
            <div class="empty-state">
                <i data-lucide="dollar-sign" style="width: 64px; height: 64px; margin: 0 auto 1rem; color: #999;"></i>
                <h3>No Pricing Strategies Yet</h3>
                <p>Create your first pricing strategy to define how prices are calculated.</p>
                <button class="btn btn-primary" onclick="createPricing()">
                    <i data-lucide="plus" style="width: 20px; height: 20px;"></i>
                    Create Pricing Strategy
                </button>
            </div>
            {{end}}
        </div>
    </div>
</div>

<!-- Pricing Modal -->
<div id="pricingModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title" id="modalTitle">New Pricing Strategy</h2>
            <button class="close-btn" onclick="closeModal()">
                <i data-lucide="x" style="width: 24px; height: 24px;"></i>
            </button>
        </div>
        <form id="pricingForm">
            <div class="form-group">
                <label class="form-label">
                    Name <span>*</span>
                </label>
                <input type="text" id="pricingName" class="form-input" placeholder="e.g., standard_family_pricing" required />
            </div>
            
            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea id="pricingDescription" class="form-textarea" placeholder="Optional description of this pricing strategy"></textarea>
            </div>
            
            <div class="form-group">
                <label class="form-label">
                    Pricing Rules <span>*</span>
                </label>
                <div class="help-text" style="margin-bottom: 1rem;">
                    Define rules that apply calculations based on conditions. Rules are evaluated in order.
                </div>
                
                <div class="rules-editor" id="rulesEditor">
                    <!-- Rules will be added here dynamically -->
                </div>
                
                <button type="button" class="btn-add-rule" onclick="addRule()">
                    <i data-lucide="plus" style="width: 16px; height: 16px;"></i>
                    Add Rule
                </button>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-cancel" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Pricing Strategy</button>
            </div>
        </form>
    </div>
</div>

<script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
<script>
    lucide.createIcons();
    
    // Set rule numbers
    document.querySelectorAll('.rule-number[data-index]').forEach(el => {
        const index = parseInt(el.getAttribute('data-index'));
        el.textContent = index + 1;
    });
    
    let currentEditId = null;
    let ruleCounter = 0;
    let availableConditions = [];
    let availableCalculations = [];
    
    // Load available conditions and calculations
    async function loadOptions() {
        try {
            const [conditionsRes, calculationsRes] = await Promise.all([
                fetch('/api/conditions'),
                fetch('/api/calculations')
            ]);
            
            if (conditionsRes.ok) {
                availableConditions = await conditionsRes.json();
            }
            if (calculationsRes.ok) {
                availableCalculations = await calculationsRes.json();
            }
        } catch (error) {
            console.error('Error loading options:', error);
        }
    }
    
    // Load options on page load
    loadOptions();
    
    function createPricing() {
        currentEditId = null;
        document.getElementById('modalTitle').textContent = 'New Pricing Strategy';
        document.getElementById('pricingForm').reset();
        document.getElementById('rulesEditor').innerHTML = '';
        ruleCounter = 0;
        
        // Add a default rule
        addRule();
        
        document.getElementById('pricingModal').classList.add('show');
    }
    
    async function editPricing(id) {
        currentEditId = id;
        document.getElementById('modalTitle').textContent = 'Edit Pricing Strategy';
        
        try {
            const response = await fetch(`/api/pricing/${id}`);
            if (response.ok) {
                const pricing = await response.json();
                document.getElementById('pricingName').value = pricing.name || '';
                document.getElementById('pricingDescription').value = pricing.description || '';
                
                // Clear existing rules
                document.getElementById('rulesEditor').innerHTML = '';
                ruleCounter = 0;
                
                // Add existing rules
                if (pricing.pricing && pricing.pricing.length > 0) {
                    pricing.pricing.forEach(rule => {
                        addRule(rule.condition, rule.calculation);
                    });
                } else {
                    addRule();
                }
                
                document.getElementById('pricingModal').classList.add('show');
            }
        } catch (error) {
            alert('Error loading pricing: ' + error.message);
        }
    }
    
    function addRule(condition = '', calculation = '') {
        const ruleId = ruleCounter++;
        const ruleDiv = document.createElement('div');
        ruleDiv.className = 'rule-editor-item';
        ruleDiv.id = `rule-${ruleId}`;
        
        // Build condition options
        let conditionOptions = '<option value="">Select condition...</option>';
        conditionOptions += '<option value="always"' + (condition === 'always' ? ' selected' : '') + '>Always (no condition)</option>';
        availableConditions.forEach(c => {
            conditionOptions += `<option value="${c.condition_name}"${condition === c.condition_name ? ' selected' : ''}>${c.condition_name}</option>`;
        });
        
        // Build calculation options
        let calculationOptions = '<option value="">Select calculation...</option>';
        availableCalculations.forEach(c => {
            calculationOptions += `<option value="${c.calculation_name}"${calculation === c.calculation_name ? ' selected' : ''}>${c.calculation_name}</option>`;
        });
        
        ruleDiv.innerHTML = `
            <div class="rule-editor-fields">
                <div class="rule-field">
                    <label>Condition</label>
                    <select class="form-select" id="condition-${ruleId}" required>
                        ${conditionOptions}
                    </select>
                </div>
                <div class="rule-field">
                    <label>Calculation</label>
                    <select class="form-select" id="calculation-${ruleId}" required>
                        ${calculationOptions}
                    </select>
                </div>
            </div>
            <button type="button" class="btn-remove-rule" onclick="removeRule(${ruleId})">
                <i data-lucide="trash-2" style="width: 16px; height: 16px;"></i>
            </button>
        `;
        
        document.getElementById('rulesEditor').appendChild(ruleDiv);
        
        // Re-render lucide icons for the new elements
        lucide.createIcons();
    }
    
    function removeRule(ruleId) {
        const ruleElement = document.getElementById(`rule-${ruleId}`);
        if (ruleElement) {
            ruleElement.remove();
        }
        
        // Ensure at least one rule exists
        const remainingRules = document.querySelectorAll('.rule-editor-item');
        if (remainingRules.length === 0) {
            addRule();
        }
    }
    
    function closeModal() {
        document.getElementById('pricingModal').classList.remove('show');
        currentEditId = null;
    }
    
    document.getElementById('pricingForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // Collect all rules
        const rules = [];
        const ruleElements = document.querySelectorAll('.rule-editor-item');
        
        for (let ruleEl of ruleElements) {
            const ruleId = ruleEl.id.replace('rule-', '');
            const condition = document.getElementById(`condition-${ruleId}`).value;
            const calculation = document.getElementById(`calculation-${ruleId}`).value;
            
            if (condition && calculation) {
                rules.push({
                    condition: condition === 'always' ? '' : condition,
                    calculation: calculation
                });
            }
        }
        
        if (rules.length === 0) {
            alert('Please add at least one pricing rule');
            return;
        }
        
        const data = {
            name: document.getElementById('pricingName').value,
            description: document.getElementById('pricingDescription').value || null,
            pricing: rules
        };
        
        try {
            const url = currentEditId ? `/api/pricing/${currentEditId}` : '/api/pricing';
            const method = currentEditId ? 'PUT' : 'POST';
            
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                window.location.reload();
            } else {
                const error = await response.json();
                alert('Error: ' + (error.error || 'Failed to save pricing'));
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    });
    
    async function deletePricing(id, name) {
        if (confirm(`Are you sure you want to delete pricing strategy "${name}"?`)) {
            try {
                const response = await fetch(`/api/pricing/${id}`, {
                    method: 'DELETE'
                });
                if (response.ok) {
                    window.location.reload();
                } else {
                    alert('Failed to delete pricing');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
    }
    
    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('pricingModal');
        if (event.target == modal) {
            closeModal();
        }
    }
</script>
</div>
{{end}}